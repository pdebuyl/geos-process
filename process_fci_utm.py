import pathlib
etc = pathlib.Path(__file__).parent / "etc_fci"
import os
os.environ['SATPY_CONFIG_PATH'] = etc.as_posix()
import hdf5plugin
import argparse
import satpy
from satpy import Scene
import pyresample
import glob
import numpy as np

parser = argparse.ArgumentParser()
parser.add_argument('--slot', required=True)
parser.add_argument('--out-dir', default='.')
parser.add_argument('--size', default=512, type=int)
args = parser.parse_args()

fnames = glob.glob(f'/mnt/GEO/archive/MTI1_{args.slot[:8]}/MTI1_{args.slot}/W*FCI*RAD*BODY*.nc')
print(len(fnames), "files found")

channels = ['ash_22_12_1']
scn = Scene(reader='fci_l1c_nc', filenames=fnames)
scn.load(channels, upper_right_corner='NE')

area_list = [
[23, 0, -500000, 1500000, 1000000, 3000000],
[23, 1, -500000, 1500000, 3000000, 5000000],
[23, 2, -500000, 1500000, 5000000, 7000000],
[26, 0, -500000, 1500000, 1000000, 3000000],
[26, 1, -500000, 1500000, 3000000, 5000000],
[26, 2, -500000, 1500000, 5000000, 7000000],
[29, 0, -500000, 1500000, 1000000, 3000000],
[29, 1, -500000, 1500000, 3000000, 5000000],
[29, 2, -500000, 1500000, 5000000, 7000000],
[32, 0, -500000, 1500000, 1000000, 3000000],
[32, 1, -500000, 1500000, 3000000, 5000000],
[32, 2, -500000, 1500000, 5000000, 7000000],
[35, 0, -500000, 1500000, 1000000, 3000000],
[35, 1, -500000, 1500000, 3000000, 5000000],
[35, 2, -500000, 1500000, 5000000, 7000000],
[38, 0, -500000, 1500000, 1000000, 3000000],
[38, 1, -500000, 1500000, 3000000, 5000000],
[38, 2, -500000, 1500000, 5000000, 7000000],
]

area_list = [
[23, 0, -250000, 1250000, 1000000, 2500000],
[23, 1, -250000, 1250000, 2500000, 4000000],
[23, 2, -250000, 1250000, 4000000, 5500000],
[23, 3, -250000, 1250000, 5500000, 7000000],
[25, 0, -250000, 1250000, 1000000, 2500000],
[25, 1, -250000, 1250000, 2500000, 4000000],
[25, 2, -250000, 1250000, 4000000, 5500000],
[25, 3, -250000, 1250000, 5500000, 7000000],
[27, 0, -250000, 1250000, 1000000, 2500000],
[27, 1, -250000, 1250000, 2500000, 4000000],
[27, 2, -250000, 1250000, 4000000, 5500000],
[27, 3, -250000, 1250000, 5500000, 7000000],
[29, 0, -250000, 1250000, 1000000, 2500000],
[29, 1, -250000, 1250000, 2500000, 4000000],
[29, 2, -250000, 1250000, 4000000, 5500000],
[29, 3, -250000, 1250000, 5500000, 7000000],
[31, 0, -250000, 1250000, 1000000, 2500000],
[31, 1, -250000, 1250000, 2500000, 4000000],
[31, 2, -250000, 1250000, 4000000, 5500000],
[31, 3, -250000, 1250000, 5500000, 7000000],
[33, 0, -250000, 1250000, 1000000, 2500000],
[33, 1, -250000, 1250000, 2500000, 4000000],
[33, 2, -250000, 1250000, 4000000, 5500000],
[33, 3, -250000, 1250000, 5500000, 7000000],
[35, 0, -250000, 1250000, 1000000, 2500000],
[35, 1, -250000, 1250000, 2500000, 4000000],
[35, 2, -250000, 1250000, 4000000, 5500000],
[35, 3, -250000, 1250000, 5500000, 7000000],
[37, 0, -250000, 1250000, 1000000, 2500000],
[37, 1, -250000, 1250000, 2500000, 4000000],
[37, 2, -250000, 1250000, 4000000, 5500000],
[37, 3, -250000, 1250000, 5500000, 7000000],
]

area_list = []
for zone in range(23, 37+1):
    for lat_idx in range(6):
        area_list.append( (zone, lat_idx, 0, 1000000, (lat_idx+1)*1000000, (lat_idx+2)*1000000) )

w = h = args.size
for area in area_list:
    zone, frame, left, right, bottom, top = area
    ad = pyresample.geometry.AreaDefinition('myUTM', 'UTM zone', 'myUTM', f"+proj=utm +zone={zone}", w, h, (left, bottom, right, top))
    utm_scn = scn.resample(ad, resampler='gradient_search')
    utm_scn.load(channels)
    utm_scn.save_datasets(filename="MTI1_{name}_{start_time:%Y%m%d%H%M}"+f"_zone{zone:02d}_frame{frame:1d}.png",
                          base_dir=args.out_dir)


